
# 结论
- debug开启存在开销，初始65M左右
- 设置limit 1C1Gi，空负载，kata_overhead单独一个cgroup查看到110M左右的mem开销，pod应用开销此时几乎为0
- sandbox_cgroup_only=false时，kata pod的kubepods pod cgroup没有数据？？
- 11.110测试kata pod 1G随机写sandbox_cgroup_only=false,机器很卡，但是不会导致pod重启及node异常;相比runc不会卡;sandbox_cgroup_only=true时也没有卡
- systemd-cgtop只能查看到kata pod的mem数据
- 开启debug_console_enabled = true后，kata_overhead有65M mem开销，跑IO测试后，此开销不会上升，但kubepod的开销就达上G
- sandbox_cgroup_only=false:kata_overhead~1.9G(default_mem 2G)
- sandbox_cgroup_only=true: 开销记入pod cgroup，~1.1G（limit+overhead）



# kata overhead测试方法
- kubectl top pods 查看应用负载 X
- 获取kata pod cgroup: 
  crictl inspect
- 查看cgroup 内存使用量 Y 
  systemd-cgtop /kubepods/pode6f3f777-4379-43af-bb06-cde1a442b4d4 -P -k --recursive=true -n 1  

- 内存开销=Y-X


# 配置：
sandbox_cgroup_only: true/false
kata podoverhead: cpu: 250m memory: 160Mi
pod resource: limit 1C1Gi
debug_console_enabled = true



# sandbox_cgroup_only=false
此时kata 开销单独在一个cgroup（kata_overhead）
## 创建测试pod前，记录当前数据
```bash
[root@localhost hff]# systemd-cgtop | grep kata
/kata_overhead                                                                 -      -    65.0M        -        -
# 这个开销应该是开启了debug_console_enabled的开销。如果不开启此时没有开销
```
grapana监控节点数据；
load:0.5左右
cpu:7%左右
mem:68%以内
io:1.0MB/s
## 启动kata monitor代理服务
```bash
[root@localhost ~]# kata-monitor
INFO[0000] announce  app=kata-monitor arch=amd64 git-commit=0ad6f05dee04dec2a653806dc7d84d2bebf50175 go-version=go1.17.3 listen-address="127.0.0.1:8090" log-level=info os=linux runtime-endpoint=/run/containerd/containerd.sock version=0.3.0
[root@localhost hff]# systemd-cgtop | grep kata
/kata_overhead                                                                 -      -    65.0M        -        -
```

## 起一个kata pod，设置limit 1C1Gi，空负载
```bash
test-kata                         1/1     Running   0          3d21h
# 查看两部分资源占用
[root@localhost hff]# systemd-cgtop | grep kata
/kata_overhead                                                                                                                -      -   175.8M        -        -
/kata_overhead/84e5718cae98b3d72a9a7267525eab84d4ea4dc0aca7367bf14dc122241cbba5                                               7      -   110.7M        -        -
## 此时空复杂开销已达110.7M  
/kubepods/pod031c021e-c722-4191-ae7b-2bd73a1aae14/kata_84e5718cae98b3d72a9a7267525eab84d4ea4dc0aca7367bf14dc122241cbba5       1      -        -        -        -

[root@localhost hff]# kubectl top pod
NAME                              CPU(cores)   MEMORY(bytes)
test-kata                         0m           0Mi
[root@localhost hff]# kubectl describe node | grep test-kata
  default                     test-kata                                                1250m (16%)   1250m (16%)  1184Mi (18%)     1184Mi (18%)   7m32s

```


## 跑10M小文件随机写测试
```bash
fio --filename=/test/randwrite --direct=1 --iodepth 1 --thread --rw=randwrite --ioengine=psync --bs=512k --size=10M --numjobs=8 --group_reporting --name=randwrite
```

```bash
[root@localhost hff]# systemd-cgtop | grep kata
/kata_overhead                                                                                                                -      -   202.2M        -        -
/kata_overhead/84e5718cae98b3d72a9a7267525eab84d4ea4dc0aca7367bf14dc122241cbba5                                               7      -   138.7M        -        -
/kubepods/pod031c021e-c722-4191-ae7b-2bd73a1aae14/kata_84e5718cae98b3d72a9a7267525eab84d4ea4dc0aca7367bf14dc122241cbba5       1      -        -        -        -
```


## 跑1G随机写测试
```bash
fio --filename=/test/randwrite --direct=1 --iodepth 1 --thread --rw=randwrite --ioengine=psync --bs=512k --size=1G --numjobs=8 --group_reporting --name=randwrite
```

```bash
[root@localhost hff]# systemd-cgtop | grep kata
/kata_overhead                                                                                                                -      -     1.1G        -        -
/kata_overhead/84e5718cae98b3d72a9a7267525eab84d4ea4dc0aca7367bf14dc122241cbba5                                               7      -     1.1G        -        -
/kubepods/pod031c021e-c722-4191-ae7b-2bd73a1aae14/kata_84e5718cae98b3d72a9a7267525eab84d4ea4dc0aca7367bf14dc122241cbba5       1      -        -        -        -
```

## 跑10G随机写测试
```bash
fio --filename=/test/randwrite --direct=1 --iodepth 1 --thread --rw=randwrite --ioengine=psync --bs=512k --size=10G --numjobs=8 --group_reporting --name=randwrite
```

```bash

[root@localhost hff]# kubectl top pod
NAME                              CPU(cores)   MEMORY(bytes)
kubefilebrowser-896974bcc-z6scd   1m           104Mi
test-kata                         25m          11Mi

[root@localhost hff]# systemd-cgtop | grep kata
/kata_overhead                                                                                                                -      -     1.9G        -        -
/kata_overhead/84e5718cae98b3d72a9a7267525eab84d4ea4dc0aca7367bf14dc122241cbba5                                               7      -     1.9G        -        -
/kubepods/pod031c021e-c722-4191-ae7b-2bd73a1aae14/kata_84e5718cae98b3d72a9a7267525eab84d4ea4dc0aca7367bf14dc122241cbba5       1      -        -        -        -
[root@localhost hff]# kubectl describe node | grep test-kata
  default                     test-kata                                                1250m (16%)   1250m (16%)  1184Mi (18%)     1184Mi (18%)   22m

top - 16:04:06 up 5 days, 20:08,  4 users,  load average: 30.93, 27.86, 17.85
Tasks: 428 total,   1 running, 427 sleeping,   0 stopped,   0 zombie
%Cpu(s): 11.0 us,  3.6 sy,  0.0 ni,  1.1 id, 84.2 wa,  0.0 hi,  0.1 si,  0.0 st
KiB Mem :  7935356 total,   138636 free,  4592924 used,  3203796 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  2485756 avail Mem


```
load: 30%左右
cpu: 几乎到100%
mem:68%~70%之间
io：100MB/s~200MB/s之间




## 删除kata pod
```bash
[root@localhost ~]# systemd-cgtop | grep kata
/kata_overhead                                                                 -      -     1.6G        -        -
```
# 创建runc pod，空负载
```bash
[root@localhost hff]# kubectl get pod
NAME                              READY   STATUS    RESTARTS   AGE
test-runc                         1/1     Running   0          4m40s
[root@localhost ~]# systemd-cgtop | grep /system.slice/containerd.service
/system.slice/containerd.service     42      -   301.9M        -        -
[root@localhost ~]# systemd-cgtop | grep pod56b53903-f73c-46cb-9d0a-560f113c1dc8
/kubepods/pod56b53903-f73c-46cb-9d0a-560f113c1dc8                                                                        -      -   728.0K        -        -
/kubepods/pod56b53903-f73c-46cb-9d0a-560f113c1dc8/406b9588ff268f5fbea764f054148a3ad829b21d9e2d980e0eaf34b7cf004a87       1      -    36.0K        -        -
/kubepods/pod56b53903-f73c-46cb-9d0a-560f113c1dc8/6d3c5cd1f1045f420cdc8da7a8ba152058458b426efe99cc1f5a2bdfb9aa5a01       3      -   692.0K        -        -
[root@localhost ~]# kubectl describe node | grep test-runc
  default                     test-runc                                                1 (12%)       1 (12%)     1Gi (15%)        1Gi (15%)      63s
[root@localhost ~]# kubectl top pod
NAME                              CPU(cores)   MEMORY(bytes)
test-runc                         0m           0Mi
```
load: 0.5多
cpu: 6.8%
mem:66.6~66.8之间
io：1MB/s以内



## 跑10M小文件随机写测试
```bash
fio --filename=/test/randwrite --direct=1 --iodepth 1 --thread --rw=randwrite --ioengine=psync --bs=512k --size=10M --numjobs=8 --group_reporting --name=randwrite
```

```bash
[root@localhost ~]# kubectl top pod
NAME                              CPU(cores)   MEMORY(bytes)
kubefilebrowser-896974bcc-z6scd   1m           104Mi
test-runc                         0m           0Mi
[root@localhost ~]# kubectl describe node | grep test-runc
  default                     test-runc                                                1 (12%)       1 (12%)     1Gi (15%)        1Gi (15%)      118s
[root@localhost ~]# systemd-cgtop | grep pod56b53903-f73c-46cb-9d0a-560f113c1dc8
/kubepods/pod56b53903-f73c-46cb-9d0a-560f113c1dc8                                                                        -      -     1.1M        -        -
/kubepods/pod56b53903-f73c-46cb-9d0a-560f113c1dc8/406b9588ff268f5fbea764f054148a3ad829b21d9e2d980e0eaf34b7cf004a87       1      -    36.0K        -        -
/kubepods/pod56b53903-f73c-46cb-9d0a-560f113c1dc8/6d3c5cd1f1045f420cdc8da7a8ba152058458b426efe99cc1f5a2bdfb9aa5a01       4      -     1.1M        -        -
```


## 跑1G随机写测试
```bash
fio --filename=/test/randwrite --direct=1 --iodepth 1 --thread --rw=randwrite --ioengine=psync --bs=512k --size=1G --numjobs=8 --group_reporting --name=randwrite
```

```bash
[root@localhost ~]# kubectl top pod
NAME                              CPU(cores)   MEMORY(bytes)
kubefilebrowser-896974bcc-z6scd   1m           104Mi
test-runc                         35m          8Mi
[root@localhost ~]# systemd-cgtop | grep pod56b53903-f73c-46cb-9d0a-560f113c1dc8
/kubepods/pod56b53903-f73c-46cb-9d0a-560f113c1dc8                                                                        -      -     8.7M        -        -
/kubepods/pod56b53903-f73c-46cb-9d0a-560f113c1dc8/406b9588ff268f5fbea764f054148a3ad829b21d9e2d980e0eaf34b7cf004a87       1      -    36.0K        -        -
/kubepods/pod56b53903-f73c-46cb-9d0a-560f113c1dc8/6d3c5cd1f1045f420cdc8da7a8ba152058458b426efe99cc1f5a2bdfb9aa5a01       5      -     8.6M        -        -


top - 16:24:33 up 5 days, 20:28,  4 users,  load average: 4.27, 2.53, 7.15
Tasks: 385 total,   1 running, 384 sleeping,   0 stopped,   0 zombie
%Cpu(s):  2.0 us,  1.0 sy,  0.0 ni, 79.6 id, 17.4 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  7935356 total,   187180 free,  4600108 used,  3148068 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  2592284 avail Mem
```
load: 3
cpu: 10~15%
mem:67以内
io：50~100MB/s以内


## 跑10G随机写测试
```bash
fio --filename=/test/randwrite --direct=1 --iodepth 1 --thread --rw=randwrite --ioengine=psync --bs=512k --size=10G --numjobs=8 --group_reporting --name=randwrite
```

```bash
[root@localhost ~]# kubectl top pod
NAME                              CPU(cores)   MEMORY(bytes)
kubefilebrowser-896974bcc-z6scd   1m           104Mi
test-runc                         14m          8Mi
[root@localhost ~]# systemd-cgtop | grep pod56b53903-f73c-46cb-9d0a-560f113c1dc8
/kubepods/pod56b53903-f73c-46cb-9d0a-560f113c1dc8                                                                        -      -     8.8M        -        -
/kubepods/pod56b53903-f73c-46cb-9d0a-560f113c1dc8/406b9588ff268f5fbea764f054148a3ad829b21d9e2d980e0eaf34b7cf004a87       1      -    36.0K        -        -
/kubepods/pod56b53903-f73c-46cb-9d0a-560f113c1dc8/6d3c5cd1f1045f420cdc8da7a8ba152058458b426efe99cc1f5a2bdfb9aa5a01       5      -     8.8M        -        -
[root@localhost ~]# systemd-cgtop | grep /system.slice/containerd.service
/system.slice/containerd.service       43      -   313.4M        -        -   43      -   
[root@localhost ~]# systemd-cgtop | grep /
/                                                                                                                      152      -     6.5G        -        -



top - 16:53:40 up 5 days, 20:57,  4 users,  load average: 7.27, 3.04, 2.59
Tasks: 387 total,   2 running, 385 sleeping,   0 stopped,   0 zombie
%Cpu(s):  7.8 us,  3.9 sy,  0.0 ni, 75.2 id, 13.2 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  7935356 total,   223424 free,  4587868 used,  3124064 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  2588184 avail Mem


```
load: 10
cpu: 22.5%
mem:68.5以内
io：100~200MB/s以内





# sandbox_cgroup_only=true
此时kata 开销统计在pod cgroup中
## 创建测试pod前，记录当前数据
```bash
[root@localhost ~]# systemd-cgtop | grep kata
/kata_overhead                                                                 -      -     1.1G        -        -


```
grapana监控节点数据；
load:0.5作用
cpu:7%作用
mem:68%以内
io:1.0MB/s

## 创建kata pod
```bash
[root@localhost ~]# systemd-cgtop | grep kata
/kata_overhead                                                                                                                -      -     1.1G        -        -
/kubepods/pod1cb49098-a5b6-4443-a28b-d007c314190d/kata_9990a39f85b71ad9faace730f72a999ec100b33d4a79ff1bb0f02450a1bf07e3       7      -   110.2M        -        -

[root@localhost ~]# kubectl top pod
NAME                              CPU(cores)   MEMORY(bytes)
test-kata                         0m           0Mi
[root@localhost ~]# kubectl describe node | grep test-kata
  default                     test-kata                                                1250m (16%)   1250m (16%)  1184Mi (18%)     1184Mi (18%)   95s


[root@localhost ~]# top
top - 18:12:57 up 5 days, 22:17,  4 users,  load average: 1.02, 0.88, 1.93
Tasks: 386 total,   1 running, 385 sleeping,   0 stopped,   0 zombie
%Cpu(s):  2.3 us,  0.8 sy,  0.0 ni, 94.5 id,  2.3 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  7935356 total,   211788 free,  4584468 used,  3139100 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  2521412 avail Mem


```
load:0.5左右
cpu:7%左右
mem:68~69%
io:1.0MB/s


## 跑10M小文件随机写测试
```bash
fio --filename=/test/randwrite --direct=1 --iodepth 1 --thread --rw=randwrite --ioengine=psync --bs=512k --size=10M --numjobs=8 --group_reporting --name=randwrite
```

```bash
[root@localhost ~]# kubectl top pod
NAME                              CPU(cores)   MEMORY(bytes)
kubefilebrowser-896974bcc-z6scd   1m           104Mi
test-kata                         1m           1Mi
[root@localhost ~]# systemd-cgtop | grep kata
/kata_overhead                                                                                                                -      -    69.9M        -        -
/kubepods/pod1cb49098-a5b6-4443-a28b-d007c314190d/kata_9990a39f85b71ad9faace730f72a999ec100b33d4a79ff1bb0f02450a1bf07e3       7      -   134.0M        -        -
```

## 跑1G随机写测试
```bash
fio --filename=/test/randwrite --direct=1 --iodepth 1 --thread --rw=randwrite --ioengine=psync --bs=512k --size=1G --numjobs=8 --group_reporting --name=randwrite
```

```bash
[root@localhost ~]# kubectl top pod
NAME                              CPU(cores)   MEMORY(bytes)
kubefilebrowser-896974bcc-z6scd   1m           104Mi
test-kata                         0m           3Mi
[root@localhost ~]# systemd-cgtop | grep kata
/kata_overhead                                                                                                                -      -    69.9M        -        -
/kubepods/pod1cb49098-a5b6-4443-a28b-d007c314190d/kata_9990a39f85b71ad9faace730f72a999ec100b33d4a79ff1bb0f02450a1bf07e3       7      -     1.1G        -        -
```

## 跑10G随机写测试
```bash
fio --filename=/test/randwrite --direct=1 --iodepth 1 --thread --rw=randwrite --ioengine=psync --bs=512k --size=10G --numjobs=8 --group_reporting --name=randwrite
```


```bash
[root@localhost ~]# kubectl top pod
NAME                              CPU(cores)   MEMORY(bytes)
kubefilebrowser-896974bcc-z6scd   1m           104Mi
test-kata                         29m          11Mi
[root@localhost ~]# systemd-cgtop | grep kata
/kata_overhead                                                                                                                -      -    69.9M        -        -
/kubepods/pod1cb49098-a5b6-4443-a28b-d007c314190d/kata_9990a39f85b71ad9faace730f72a999ec100b33d4a79ff1bb0f02450a1bf07e3       7      -     1.1G        -        -

top - 18:20:46 up 5 days, 22:24,  4 users,  load average: 6.26, 3.02, 2.33
Tasks: 492 total,   1 running, 491 sleeping,   0 stopped,   0 zombie
%Cpu(s):  2.6 us,  1.0 sy,  0.0 ni, 67.1 id, 29.3 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  7935356 total,   225736 free,  4675472 used,  3034148 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  2415352 avail Mem

```
load: 10以内
cpu:40~60%左右
mem:70以内%
io:100~200MB/s


# kata vs runc（caihcloud）
## kata
测试前：
```bash
[root@localhost ~]# systemd-cgtop | grep kata
/kata_overhead                                                                 -      -    60.5M        -        -
```

```bash
[root@localhost ~]# systemd-cgtop | grep kata
/kata_overhead                                                                 -      -    50.5M        -        -

[root@localhost ~]# systemd-cgtop | grep pod3a467c3b-a64e-43c1-afef-417a34f0eee3
/kubepods/burstable/pod3a467c3b-a64e-43c1-afef-417a34f0eee3                    -      -   672.4M        -        -

[root@localhost ~]# free -h
              total        used        free      shared  buff/cache   available
Mem:           7.6G        4.3G        200M        959M        3.1G        2.0G
Swap:            0B          0B          0B

top - 15:39:25 up 6 days, 19:43,  1 user,  load average: 1.38, 1.32, 1.15
Tasks: 363 total,   1 running, 362 sleeping,   0 stopped,   0 zombie
%Cpu(s):  1.6 us,  0.8 sy,  0.0 ni, 96.9 id,  0.8 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  7935356 total,   215364 free,  4492324 used,  3227668 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  2147624 avail Mem

```

## runc
```bash
[root@localhost ~]#  systemd-cgtop | grep podba3213c0-2204-4641-a3e8-b2bd2a178684
/kubepods/burstable/podba3213c0-2204-4641-a3e8-b2bd2a178684                    -      -   128.4M        -        -


[root@localhost ~]# free -h
              total        used        free      shared  buff/cache   available
Mem:           7.6G        4.4G        670M        409M        2.6G        2.5G
Swap:            0B          0B          0B

top - 15:44:53 up 6 days, 19:49,  1 user,  load average: 1.22, 1.10, 1.10
Tasks: 359 total,   1 running, 358 sleeping,   0 stopped,   0 zombie
%Cpu(s):  4.8 us,  2.4 sy,  0.0 ni, 92.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  7935356 total,   677724 free,  4568724 used,  2688908 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  2634468 avail Mem

```








